# Nutanix on Equinix Metal with Active Directory Authentication

## Introduction

Nutanix Prism allows using Windows Active Directory as an authentication mode.
This example will help:

- Create nutanix prism cluster on equinix
- An AD server VM
- AD authentication configured on Equnix
- A few roles mapped to the AD with `Cluster Admin` and `User Admin`

The example is almost automated but needs to setup prism central manually.

## Prerequisites

- [Terraform installed](https://developer.hashicorp.com/terraform/install)
- [Equinix Metal account](https://deploy.equinix.com/developers/docs/metal/identity-access-management/users/) with an [API key](https://deploy.equinix.com/developers/docs/metal/identity-access-management/api-keys/).
- SSH key pair for accessing the Nutanix clusters or

you can reuse the SSH private key generated by the example with the name prefix `ssh-key-xxxxx` at Current lcoation.

### Clone the repository

 ```sh
 git clone git@github.com:equinix-labs/terraform-equinix-metal-nutanix-cluster.git
 cd terraform-equinix-metal-nutanix-cluster
 cd examples/nutanix-clusters
 ```

## How to use the module

To create a setup of nutanix prism clusters with an AD server and AD authentication on prism element, we need to run this example module and follow the further steps to configure prism central.

### **Provide TF variables to the module**

If you have the [Metal CLI](https://deploy.equinix.com/developers/docs/metal/libraries/cli/) configured, the following will setup your authentication and project settings in an OSX or Linux shell environment.

```sh
eval $(metal env -o terraform --export) #
export TF_VAR_metal_metro=sl # Deploy to Seoul
```

Otherwise, copy [`terraform.tfvars.example`](../../terraform.tfvars.example) to `terraform.tfvars` and edit the input values before continuing.

#### The file will look like below

```hcl
 metal_project_id       = "XXXX-XXXX-XXXX-XXXXXX-XXXXX"
 metal_organization_id  = "XXXX-XXXX-XXXX-XXXXXX-XXXXX" # The ID of the Metal organization in which to create the project if `create_project` is true.
 metal_metro            = "sl"                                   # The metro to create the cluster in
 create_project         = false                                  # (Optional) to use an existing project matching `metal_project_name`, set this to false.
 metal_bastion_plan     = "m3.small.x86"                         # Which plan to use for the bastion host.
 metal_nutanix_os       = "nutanix_lts_6_5"                      # Which OS to use for the Nutanix nodes.
 metal_nutanix_plan     = "m3.large.x86"                         # Which plan to use for the Nutanix nodes (must be Nutanix compatible, see https://deploy.equinix.com/developers/os-compatibility/)
 create_vlan            = false                                  # Whether to create a new VLAN for this project.
 create_vrf             = true
 metal_vlan_id          = null # ID of the VLAN you wish to use. e.g. 1234
 nutanix_node_count    = 1                 # The number of Nutanix nodes to create.
 skip_cluster_creation = false             # Skip the creation of the Nutanix cluster.
 cluster_subnet        = "192.168.96.0/21" # Pick an arbitrary private subnet, we recommend a /22 like "192.168.100.0/22"
 nutanix_reservation_ids=[] # Hardware reservation IDs to use for the Nutanix nodes
 ```

There are a few variables from above for which, if the values are not passed into them, this module will try to create the new instance of the same:

- `metal_project_id`: If not passed a new metal project will be created. This should work in conjunction with value of `create_project`. If `create_project == false` and `metal_project_id` is not passed, its an error.
- `metal_vlan_id`: If not passed a new metal vlan will be created. This should work in conjunction with value of `create_vlan`. If `create_vlan == false` and `metal_vlan_id` is not passed, its an error.
- `vrf_id`: If not passed a new metal vrf will be created. This should work in conjunction with value of `create_vrf`. If `create_vrf == false` and `vrf_id` is not passed, its an error.

You need to provide a new password in the TF vars file which will be set to the Prism Element by changing the older default password `Nutanix/4u`.

### Apply the module

 ```sh
 terraform init
 terraform plan
 terraform apply
 ```

### A successful response will look like

 ```sh
 Outputs:
 prism_central_ip_address = "192.168.103.252"
 bastion_public_ip = "145.40.91.141"
 ssh_forward_command = "ssh -L 9442:192.168.102.176:9440 -L 19442:192.168.103.252:9440 -i /Users/vasubabu/Equinix/terraform-equinix-metal-nutanix-cluster/examples/nutanix-clusters/ssh-key-lha20 root@145.40.91.141"
 ad_server_ip = "192.168.103.254"
 ```

### A Prism Cluster is successfully configured with an Active Directory

![Active_Directory_setup.png](assets/Active_Directory_setup.png)

### Roles mapped to the ad server

![Role_mappings.png](assets/Role_mappings.png)

### We have a Running Equinix Devices representing Prism Cluster and an AD Server**

![Nutanix_Equinix_console.png](assets/Nutanix_Equinix_console.png)

## To Login to the Prism GUI

- SSH port forward session with the bastion host:

  **Mac or Linux**

  ```sh
  $(terraform output -raw ssh_forward_command)
  ```

  **Windows**

  ```sh
  invoke-expression $(terraform output -raw ssh_forward_command)
  ```

- Then open a browser and navigate to <https://localhost:9440> (the certificate will not match the domain)

To login, you can use credentials

- **Username** : The default username: `admin` or `Admin@equinixad.com` as the user from AD Server.
- **Password** : Password is the value provided in TF Vars (`terraform.tfvars`) file with the key `new_prism_password`.

### Now, you can try out with configured AD users on the Prism Element

- By default, The user `Admin` already mapped on the prism with Cluster Admin and User Admin roles.

To login to the prism ui, follow the steps as mentioned [here](./README.md#to-login-to-the-prism-gui).

Make sure you add domain as well to the username of the prism ex: `admin@equinixad.com`

### To support more users login

For more users, you can add a user/group to AD Server.

- RDP into the `ad-server` metal device/VM.
- Add more users and groups to AD.

```powershell
New-ADUser user01`
-Surname user01 `
-GivenName user01 `
-DisplayName "AD User01" `
-EmailAddress "user01@equinixad.com" `
-AccountPassword (ConvertTo-SecureString -AsPlainText "<password_here>" -Force) `
-ChangePasswordAtLogon $true `
-Enabled $true
```

Please refer [here](https://www.server-world.info/en/note?os=Windows_Server_2022&p=active_directory&f=4) for more details

- And Then add role_mappings for those users in Prism Element. From Prism Web console > Settings > Role Mapping.

Follow [this](https://portal.nutanix.com/page/documents/details?targetId=Nutanix-Security-Guide-v6_8:wc-security-role-permissions-wc-t.html) guide for detailed steps.

## Next Steps, Setup the Prism Central instance (Optional)

### To get more powerful capabilities of Nutanix, setup prism central

1. **Login Prism UI**

   Using the steps above [here](./README.md#to-login-to-the-prism-gui) login to Prism Element UI.

   Note: Remember to use the new password set in the `terraform.tfvars` file as it was reset by this module.

2. **Follow these instructions from the workshop to configure**

   [Nutanix Prism Cluster on Equinix Metal](https://equinix-labs.github.io/nutanix-on-equinix-metal-workshop/parts/5-prism_central/#part-5-deploy-prism-central)

**These steps will guide you through the configuration of VirtualIP, ISCSI IP, NTP Servers and deploying Prism Central Instance.**
